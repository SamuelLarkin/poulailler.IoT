# poulailler.IoT

Suivre la temperature et le taux d'humidite dans le poulailler



## Arduino Boards

* [Difference between ESP8622 & ESP32](https://makeradvisor.com/esp32-vs-esp8266/)
* [ESP32 Development Boards Review Comparison](https://makeradvisor.com/esp32-development-boards-review-comparison/)



## AdaFruit Feather HUZZAH ESP8266

AdaFruit Feather HUZZAH ESP8266 on COM4

* [adafruit-feather-HUZZAH-esp8266 - pinouts image](https://cdn-learn.adafruit.com/assets/assets/000/046/249/original/adafruit_products_Huzzah_ESP8266_Pinout_v1.2-1.png?1504885873)
* [adafruit-feather-huzzah-esp8266 - pinouts](https://learn.adafruit.com/adafruit-feather-huzzah-esp8266/pinouts)
* [adafruit-feather-huzzah-esp8266 - using-arduino-ide](https://learn.adafruit.com/adafruit-feather-huzzah-esp8266/using-arduino-ide)
* [adafruit-feather-huzzah-esp8266 - using-nodemcu-lua](https://learn.adafruit.com/adafruit-feather-huzzah-esp8266/using-nodemcu-lua)




## Raspberry Pi

### GPIO

* [Raspberry gPIo](https://learn.sparkfun.com/tutorials/raspberry-gpio/all#python-rpigpio-api)
* [Raspberry Pinout](https://cdn.sparkfun.com/assets/learn_tutorials/4/2/4/header_pinout.jpg)
* [Turning on an LED with your Raspberry Pi's GPIO Pins](https://thepihut.com/blogs/raspberry-pi-tutorials/27968772-turning-on-an-led-with-your-raspberry-pis-gpio-pins)

### WebCam with motion

USB Webcam - Logitech Quickcam 9000
* [MotionEye on a Raspberry Pi](https://github.com/ccrisan/motioneye/wiki/Install-On-Raspbian)
* [Getting a picture out of a Logitech Quickcam 9000 Pro](https://www.raspberrypi.org/forums/viewtopic.php?t=10496#p123631)

### Cases

* [Best 8 raspberry pi 4 cases in 2019](https://www.seeedstudio.com/blog/2019/09/19/best-8-raspberry-pi-4-cases-in-2019/)
* [SparkFun](https://www.sparkfun.com/categories/182)
* [Argon40](https://www.argon40.com/raspberry-pi-cases.html)



## Buy

| Price | Link |
|:-----|:------|
| CA$4.64 | [D1 Mini V2 NodeMcu 4M Bytes Lua WIFI Internet Of Things Development Board Based ESP8266 Geekcreit for Arduino - products that work with official Arduino boards](https://www.banggood.com/D1-Mini-V2-NodeMcu-4M-Bytes-Lua-WIFI-Internet-Of-Things-Development-Board-Based-ESP8266-p-1115398.html?p=CS101558118042016088&utm_content=tanghao&utm_campaign=mesh&cur_warehouse=CN) |
| $9.99 | [Makerfocus D1 Mini NodeMcu 4M Bytes Lua WiFi Development Board Base on ESP8266 ESP-12F N Compatible NodeMcu Arduino](https://www.amazon.com/Makerfocus-NodeMcu-Development-ESP8266-Compatible/dp/B01N3P763C/ref=as_li_ss_tl?s=electronics&ie=UTF8&qid=1521437976&sr=1-1&keywords=d1+mini&linkCode=sl1&tag=drzzs0e-20&linkId=71a3816fd425694ae9a07c279d6cce74) |
| | [buyapi esp8266 query](https://www.buyapi.ca/search.php?search_query=esp8266&section=product) |
| $13.95 | [Adafruit HUZZAH ESP8266 Breakout](https://www.buyapi.ca/product/adafruit-huzzah-esp8266-breakout/) |
| | [Sonoff Express](https://www.aliexpress.com/item/4000180793880.html?src=google&src=google&albch=shopping&acnt=494-037-6276&isdl=y&slnk=&plac=&mtctp=&albbt=Google_7_shopping&aff_platform=google&aff_short_key=UneMJZVf&&albagn=888888&albcp=7386552844&albag=80241711349&trgt=539263010115&crea=en4000180793880&netw=u&device=c&gclid=EAIaIQobChMI_5PT2vTV5QIVBp6fCh3xawQXEAQYASABEgK3I_D_BwE&gclsrc=aw.ds) |
| 22.95$ | [Adafruit Feather HUZZAH with ESP8266 WiFi](https://www.buyapi.ca/product/adafruit-feather-huzzah-with-esp8266-wifi/) |
| CA$8.68 | [ESP32 Development Board WiFi+bluetooth Ultra Low Power Consumption Dual Cores ESP-32 ESP-32S Board Geekcreit for Arduino - products that work with official Arduino boards](https://www.banggood.com/ESP32-Development-Board-WiFibluetooth-Ultra-Low-Power-Consumption-Dual-Cores-ESP-32-ESP-32S-Board-p-1109512.html?p=MA240439985285201910&cur_warehouse=CN) |
| CA$12.02 | [LILYGO® TTGO T-Energy ESP32 8MByte PSRAM WiFi bluetooth Module 18650 Battery ESP32-WROVER-IB Development Board](https://www.banggood.com/LILYGO-TTGO-T-Energy-ESP32-8MByte-PSRAM-WiFi-bluetooth-Module-18650-Battery-ESP32-WROVER-IB-Development-Board-p-1427125.html?p=MA240439985285201910&cur_warehouse=CN) |
| CA$13.35 | [Geekcreit ESP32 OLED Module For ESP32 OLED WiFi + bluetooth Dual ESP-32 ESP-32S ESP8266 OLED Module](https://www.banggood.com/Geekcreit-ESP32-OLED-Module-For-Arduino-ESP32-OLED-WiFi-bluetooth-Dual-ESP-32-ESP-32S-ESP8266-p-1148119.html?p=MA240439985285201910&cur_warehouse=CN) |
| CA$9.34 | [ESP32-CAM WiFi + bluetooth Camera Module Development Board ESP32 With Camera Module OV2640 Geekcreit for Arduino - products that work with official Arduino boards](https://www.banggood.com/ESP32-CAM-WiFi-bluetooth-Camera-Module-Development-Board-ESP32-With-Camera-Module-OV2640-p-1394679.html?rmmds=category&cur_warehouse=CN) |


## Tutorial

* [esp8266-dht11dht22-temperature-and-humidity-web-server-with-arduino-ide](https://randomnerdtutorials.com/esp8266-dht11dht22-temperature-and-humidity-web-server-with-arduino-ide/)
* [ESP32](https://en.wikipedia.org/wiki/ESP32)
* [ESP8266 Temperature / Humidity Webserver](https://learn.adafruit.com/esp8266-temperature-slash-humidity-webserver/code)
* [Adding a DHT22 temperature and humidity sensor to the Sonoff](https://tritek.pw/2016/05/24/adding-a-dht22-temperature-and-humidity-sensor-to-the-sonoff/)
* [Tasmota + D1mini (or Sonoff) - Temp & Humidity, ws2812 LEDs, and Motion Detection](https://www.youtube.com/watch?v=sVml02kP3DU)
* [DIY Lipo Wireless Temperature Sensor ESP8266 // Less than $5](https://www.youtube.com/watch?v=7tGPpG_9hik)
* [esp8266-pinout-reference-gpios](https://randomnerdtutorials.com/esp8266-pinout-reference-gpios/)
* [ESP8266-12-blynk-wireless-temperature-LM35-sensor](https://www.instructables.com/id/ESP8266-12-blynk-wireless-temperature-LM35-sensor/)
* [ESP12-and-DHT22](https://cityos.io/tutorial/2006/ESP12-and-DHT22)
* [getting-started-with-the-esp8266-and-dht22-sensor](https://www.losant.com/blog/getting-started-with-the-esp8266-and-dht22-sensor)



## Software

* [How would you like to use losant?](https://www.losant.com/)
* [Tasmota](https://github.com/arendst/Tasmota)
* [Home Assistant](https://www.home-assistant.io/getting-started/)
* [xively](https://xively.com/)
* [micropython](https://docs.micropython.org/en/latest/esp8266/tutorial/intro.html)
* [nodemcu](https://www.nodemcu.com/index_en.html#fr_54745c8bd775ef4b99000011)
 *[CircuitPython](https://circuitpython.org/)



## Technical Info

* Operating temperature range of ESP8266 is from -40℃ to 125℃. At present, ESP8266 has passed FCC, CE and WiFi Alliance, all are in industrial level.
* First of all, according to raspberry.org: "The Raspberry Pi is built from commercial chips which are qualified to different temperature ranges; the LAN9512 is specified by the manufacturers being qualified from 0°C to 70°C, while the AP is qualified from -40°C to 85°C.
* [ESP8266EX DataSheet](https://www.espressif.com/sites/default/files/documentation/0a-esp8266ex_datasheet_en.pdf)



## Software

### Mosquitto

* https://randomnerdtutorials.com/esp8266-and-node-red-with-mqtt/
* http://www.steves-internet-guide.com/mosquitto_pub-sub-clients/
* http://www.steves-internet-guide.com/mqtt/

`mosquitto -v`
```
1579231786: mosquitto version 1.5.7 starting
1579231786: Using default config.
1579231786: Opening ipv4 listen socket on port 1883.
1579231786: Error: Address already in use
```

```
mosquitto_sub -t '#' -v
poulailler/temperature 18.20
poulailler/humidite 24.10
```

```
mosquitto_sub -t '#' -v -d
Client mosqsub|6076-raspberryp sending CONNECT
Client mosqsub|6076-raspberryp received CONNACK (0)
Client mosqsub|6076-raspberryp sending SUBSCRIBE (Mid: 1, Topic: #, QoS: 0)
Client mosqsub|6076-raspberryp received SUBACK
Subscribed (mid: 1): 0
Client mosqsub|6076-raspberryp received PUBLISH (d0, q0, r0, m0, 'poulailler/temperature', ... (5 bytes))
poulailler/temperature 18.50
Client mosqsub|6076-raspberryp received PUBLISH (d0, q0, r0, m0, 'poulailler/humidite', ... (5 bytes))
poulailler/humidite 24.70
Client mosqsub|6076-raspberryp received PUBLISH (d0, q0, r0, m0, 'poulailler/temperature', ... (5 bytes))
poulailler/temperature 18.50
Client mosqsub|6076-raspberryp received PUBLISH (d0, q0, r0, m0, 'poulailler/humidite', ... (5 bytes))
poulailler/humidite 24.90
```


### Node-Red

http://192.168.X.Y:1880
http://192.168.X.Y:1880/ui

* [Get Started](https://nodered.org/#get-started)

If msg.payload is an object containing multiple properties, the fields will be written to the measurement.

For example, the following flow injects three fields, numValue, randomValue and strValue into the same measurement with the current timestamp.

```
[ 
   { 
      "id":"eba91e98.1456e",
      "type":"influxdb",
      "z":"b061b303.4f9e5",
      "hostname":"127.0.0.1",
      "port":"8086",
      "database":"aTimeSeries",
      "name":"aTimeSeries"
   },
   { 
      "id":"baee675c.451198",
      "type":"inject",
      "z":"b061b303.4f9e5",
      "name":"",
      "topic":"",
      "payload":"",
      "payloadType":"date",
      "repeat":"",
      "crontab":"",
      "once":false,
      "x":103,
      "y":177,
      "wires":[ 
         [ 
            "827180cf.7d8e8"
         ]
      ]
   },
   { 
      "id":"827180cf.7d8e8",
      "type":"function",
      "z":"b061b303.4f9e5",
      "name":"Fields",
      "func":"msg.payload = {\n    numValue: 123.0,\n    strValue: \"message\",\n    randomValue: Math.random()*10\n}\nreturn msg;",
      "outputs":1,
      "noerr":0,
      "x":251,
      "y":177,
      "wires":[ 
         [ 
            "c36cb4d6.3c9348"
         ]
      ]
   },
   { 
      "id":"c36cb4d6.3c9348",
      "type":"influxdb out",
      "z":"b061b303.4f9e5",
      "influxdb":"eba91e98.1456e",
      "name":"",
      "measurement":"test",
      "x":421,
      "y":177,
      "wires":[ 

      ]
   }
]
```

The function node in the flow above consists of the following:

```
msg.payload = {
  numValue: 123.0,
  strValue: "message",
  randomValue: Math.random()*10
}
return msg;
```

If msg.payload is an array containing two objects, the first object will be written as the set of named fields, the second is the set of named tags.

For example, the following simple flow injects three fields as above, along with two tags, tag1 and tag2:

```
[ 
   { 
      "id":"eba91e98.1456e",
      "type":"influxdb",
      "z":"b061b303.4f9e5",
      "hostname":"127.0.0.1",
      "port":"8086",
      "database":"aTimeSeries",
      "name":"aTimeSeries"
   },
   { 
      "id":"7f25337e.80dacc",
      "type":"inject",
      "z":"b061b303.4f9e5",
      "name":"",
      "topic":"",
      "payload":"",
      "payloadType":"date",
      "repeat":"",
      "crontab":"",
      "once":false,
      "x":101,
      "y":248,
      "wires":[ 
         [ 
            "bb0ff0.ff44f01"
         ]
      ]
   },
   { 
      "id":"bb0ff0.ff44f01",
      "type":"function",
      "z":"b061b303.4f9e5",
      "name":"Fields and Tags",
      "func":"msg.payload = [{\n    numValue: 12,\n    randomValue: Math.random()*10,\n    strValue: \"message2\"\n},\n{\n    tag1:\"sensor1\",\n    tag2:\"device2\"\n}];\nreturn msg;",
      "outputs":1,
      "noerr":0,
      "x":272,
      "y":248,
      "wires":[ 
         [ 
            "8e2713fa.71d8f"
         ]
      ]
   },
   { 
      "id":"8e2713fa.71d8f",
      "type":"influxdb out",
      "z":"b061b303.4f9e5",
      "influxdb":"eba91e98.1456e",
      "name":"",
      "measurement":"test",
      "x":460,
      "y":248,
      "wires":[ 

      ]
   }
]
```

The function node consists of the following code:

```
msg.payload = [{
  numValue: 12,
  randomValue: Math.random()*10,
  strValue: "message2"
},
{
  tag1:"sensor1",
  tag2:"device2"
}];
return msg;
```

Finally, if msg.payload is an array of arrays, it will be written as a series of points containing fields and tags.

For example, the following flow injects two points with timestamps specified.

```
[ 
   { 
      "id":"eba91e98.1456e",
      "type":"influxdb",
      "z":"b061b303.4f9e5",
      "hostname":"127.0.0.1",
      "port":"8086",
      "database":"aTimeSeries",
      "name":"aTimeSeries"
   },
   { 
      "id":"9555a67c.6aaa58",
      "type":"function",
      "z":"b061b303.4f9e5",
      "name":"multiple readings",
      "func":"msg.payload = [\n    [{\n        numValue: 10,\n        randomValue: Math.random()*10,\n        strValue: \"message1\",\n        time: new Date(\"2015-12-28T19:41:13Z\").getTime()\n    },\n    {\n        tag1:\"sensor1\",\n        tag2:\"device2\"\n    }],\n    [{\n        numValue: 20,\n        randomValue: Math.random()*10,\n        strValue: \"message2\",\n        time: new Date(\"2015-12-28T19:41:14Z\").getTime()\n    },\n    {\n        tag1:\"sensor1\",\n        tag2:\"device2\"\n    }]\n];\nreturn msg;",
      "outputs":1,
      "noerr":0,
      "x":278,
      "y":335,
      "wires":[ 
         [ 
            "f485378d.0b7ac8"
         ]
      ]
   },
   { 
      "id":"68b911d9.9746f",
      "type":"inject",
      "z":"b061b303.4f9e5",
      "name":"",
      "topic":"",
      "payload":"",
      "payloadType":"date",
      "repeat":"",
      "crontab":"",
      "once":false,
      "x":104,
      "y":335,
      "wires":[ 
         [ 
            "9555a67c.6aaa58"
         ]
      ]
   },
   { 
      "id":"f485378d.0b7ac8",
      "type":"influxdb out",
      "z":"b061b303.4f9e5",
      "influxdb":"eba91e98.1456e",
      "name":"",
      "measurement":"test",
      "x":479,
      "y":334,
      "wires":[ 

      ]
   }
]
```

The function node in the above flow looks as follows:

```
msg.payload = [
[{
    numValue: 10,
    randomValue: Math.random()*10,
    strValue: "message1",
    time: new Date("2015-12-28T19:41:13Z").getTime()
},
{
    tag1:"sensor1",
    tag2:"device2"
}],
[{
    numValue: 20,
    randomValue: Math.random()*10,
    strValue: "message2",
    time: new Date("2015-12-28T19:41:14Z").getTime()
},
{
    tag1:"sensor1",
    tag2:"device2"
}]
];
return msg;
```

Note how timestamps are specified - the number of milliseconds since 1 January 1970 00:00:00 UTC.

[Post data to InfluxDB](https://flows.nodered.org/flow/1d06cc6dbb57544f2d8b)

`network,device={{topic}} value={{payload}}`

```
  {
    "id": "f9c2968b.063d68",
    "type": "template",
    "z": "106a5b82.ef95a4",
    "name": "Fmt Influx Output",
    "field": "payload",
    "fieldType": "msg",
    "format": "handlebars",
    "syntax": "mustache",
    "template": "network,device={{topic}} value={{payload}}",
    "x": 470,
    "y": 640,
    "wires": [
      [
        "fae034e2.051fc8"
      ]
    ]
  },
```

[source](https://flows.nodered.org/node/node-red-contrib-influxdb)
```
msg.payload = [
    [{
        numValue: 10,
        randomValue: Math.random()*10,
        strValue: "message1",
        time: new Date("2015-12-28T19:41:13Z").getTime()
    },
    {
        tag1:"sensor1",
        tag2:"device2"
    }],
    [{
        numValue: 20,
        randomValue: Math.random()*10,
        strValue: "message2",
        time: new Date("2015-12-28T19:41:14Z").getTime()
    },
    {
        tag1:"sensor1",
        tag2:"device2"
    }]
];
return msg;
```



### InfluxDB

influxdb:8086

* [Download](https://www.influxdata.com/get-influxdb/)
* [Database management using InfluxQL](https://docs.influxdata.com/influxdb/v1.7/query_language/database_management/)
* [influx retention](https://bl.ocks.org/nl-hugo/acf9ceabb9a813d067484d9723ca3f77)
* [InfluxDB plugin for Node-Red](https://www.npmjs.com/package/node-red-contrib-influxdb)


#### Create a Database

[How to set default retention policy and duration for InfluxDB via configuration](https://stackoverflow.com/a/41640770)

```
CREATE DATABASE <database_name>
[WITH [DURATION <duration>] [REPLICATION <n>]
      [SHARD DURATION <duration>] [NAME <retention-policy-name>]]
```


#### Retention Policies

```
CREATE RETENTION POLICY <retention_policy_name> ON <database_name> DURATION <duration> REPLICATION <n> [SHARD DURATION <duration>] [DEFAULT]
```

```
# every 10s
# 24h * 60min/h * 6/min = 8640
CREATE RETENTION POLICY "jour" ON "poulailler" DURATION 1d REPLICATION 1 DEFAULT
# every 2 mins
# 7d/w 24h/d * 12/h = 5040
CREATE RETENTION POLICY "semaine" ON "poulailler" DURATION 1w REPLICATION 1
# every 15 mins
# 365d/y * 24h/d * 4/h = 35040
CREATE RETENTION POLICY "annee" ON "poulailler" DURATION 52w REPLICATION 1
```


#### Continuous Queries

[Continuous Queries Advanced Syntax](https://docs.influxdata.com/influxdb/v1.7/query_language/continuous_queries/#advanced-syntax)

```
CREATE CONTINUOUS QUERY <cq_name> ON <database_name>
RESAMPLE EVERY <interval> FOR <interval>
BEGIN
  <cq_query>
END
```

```
cq_query
SELECT <function[s]> INTO <destination_measurement> FROM <measurement> [WHERE <stuff>] GROUP BY time(<interval>)[,<tag_key[s]>]
```

Automatically downsampling data into another retention policy

Fully qualify the destination measurement to store the downsampled data in a non-DEFAULT retention policy (RP).

Automatically downsampling a database with backreferencing

Use a function with a wildcard (*) and INTO query’s backreferencing syntax to automatically downsample data from all measurements and numerical fields in a database.

```
CREATE CONTINUOUS QUERY "cq_basic_br" ON "transportation"
BEGIN
  SELECT mean(*) INTO "downsampled_transportation"."autogen".:MEASUREMENT FROM /.*/ GROUP BY time(30m),*
END
```


#### Create the Database

```
#CREATE DATABASE poulailler
CREATE DATABASE poulailler
  WITH DURATION 1d
  REPLICATION 1
  NAME jour
```

```
#CREATE RETENTION POLICY jour ON "poulailler" DURATION 1d REPLICATION 1 DEFAULT
CREATE RETENTION POLICY semaine ON "poulailler" DURATION 1w REPLICATION 1
CREATE RETENTION POLICY annee ON "poulailler" DURATION 52w REPLICATION 1
```

```
CREATE CONTINUOUS QUERY cq_2m ON poulailler BEGIN
  SELECT mean(temperature) AS temperature, mean(humidite) AS humidite
  INTO poulailler.semaine.metrics
  FROM metrics
  GROUP BY time(2m)
END

CREATE CONTINUOUS QUERY cq_15m ON poulailler BEGIN
  SELECT mean(temperature) AS temperature, mean(humidite) AS humidite
  INTO poulailler.annee.metrics
  FROM metrics
  GROUP BY time(15m)
END
```



### Grafana

http://192.168.X.Y:3000

* [Howto Install InfluxDB an Grafana on a Raspberry pi 3](http://blog.centurio.net/2018/10/28/howto-install-influxdb-and-grafana-on-a-raspberry-pi-3/)



## To Classify

* https://pimylifeup.com/raspberry-pi-influxdb/
* https://gist.github.com/xoseperez/e23334910fb45b0424b35c422760cb87
* https://learn.adafruit.com/mini-smart-home-with-esp8266-huzzah-feather-raspberry-pi-hassio-crickit/mqtt-setup-2
* https://randomnerdtutorials.com/esp8266-and-node-red-with-mqtt/
* https://www.balena.io/blog/build-an-environment-and-air-quality-monitor-with-raspberry-pi/#2settinguptheraspberrypi
